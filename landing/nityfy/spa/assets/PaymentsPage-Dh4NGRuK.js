import{Q as ae,a as T,b as le,c as F}from"./QTabPanels-CJnekpGK.js";import{o as oe,m as ne,n as se,p as l,q as o,f as e,X as r,Q as m,z as c,a8 as g,v as V,N as de,t as M,W as z,Y as q,P as f,a7 as L,D as P,O as v,r as u,c as j}from"./index-BCoBQOFT.js";import{Q as R,a as S}from"./QTable-Dv_xctJK.js";import{Q as re}from"./QBadge-CD0MS9Rg.js";import{Q as C}from"./QSelect-DZMeRPTx.js";import{Q as ue}from"./QBanner-9GPSZcrN.js";import{Q as ie}from"./QPage-DNQfSVvF.js";import{C as Q}from"./ClosePopup-DoFqAVUY.js";import{u as me}from"./use-quasar-DuPF83ky.js";import{u as ce}from"./currency-FmnwYlLu.js";import{_ as pe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./QResizeObserver-CLJoVRmi.js";import"./touch-BjYP5sR0.js";import"./position-engine-BGz6yeZ8.js";import"./use-render-cache-DLxPkVnQ.js";import"./QList-TwHTGU55.js";import"./QLinearProgress-DcUDM4wH.js";import"./QChip-B9sWOFsV.js";import"./QItem-Wb4A_Ad7.js";import"./QItemLabel-djxoAbwS.js";import"./QMenu-CRQWq3Fk.js";import"./format-CoaQEihs.js";import"./index-D5GkNzM3.js";const ge={class:"row items-center justify-end q-mb-md"},fe={class:"row q-col-gutter-md q-mb-lg"},ve={class:"col-12 col-md-4"},be={class:"text-h4 text-weight-bold text-green-9 q-mt-xs"},ye={class:"col-12 col-md-4"},we={class:"text-h4 text-weight-bold text-orange-9 q-mt-xs"},xe={class:"row q-col-gutter-sm q-mb-md"},he={class:"col-12 col-md-3"},_e={class:"col-12 col-md-3"},Ve={class:"row items-center justify-end q-mb-md"},qe={class:"row q-col-gutter-md q-mb-lg"},Pe={class:"col-12 col-md-4"},Se={class:"text-h4 text-weight-bold text-red-9 q-mt-xs"},Ce={class:"col-12 col-md-4"},Qe=125e3,De={__name:"PaymentsPage",setup(Ne){const p=me(),i=ce(),b=u("payments"),y=u(!1),s=u({}),J=[{name:"date",label:"Date",field:"date",align:"left",sortable:!0},{name:"student",label:"Student",field:"student",align:"left",sortable:!0},{name:"month",label:"For Month",field:"month",align:"left"},{name:"amount",label:"Amount",field:"amount",align:"right",format:n=>i.format(n)},{name:"status",label:"Status",field:"status",align:"center"}],A=u([]),E=async()=>{try{const{data:n,error:t}=await v.from("payments").select("*, students(name)").order("created_at",{ascending:!1});if(t)throw t;A.value=n.map(a=>({id:a.id,date:new Date(a.payment_date).toISOString().split("T")[0],student:a.students?a.students.name:"Unknown",month:a.payment_month,amount:a.amount,status:"Paid"}))}catch(n){console.error("Error fetching payments:",n),p.notify({type:"negative",message:"Failed to load payments"})}};oe(()=>{E()});const K=()=>{s.value={status:"Paid",amount:""},y.value=!0},H=async()=>{if(!s.value.studentName||!s.value.amount||!s.value.month){p.notify({type:"warning",message:"Please fill all fields"});return}try{const{data:{user:n}}=await v.auth.getUser();if(!n)return;const{data:t}=await v.from("profiles").select("plan_type, country_code").eq("id",n.id).single(),a=t?.plan_type||"free",h=t?.country_code||"LK",k=Number(s.value.amount);let _=0;a==="growth"&&(h==="SL"||h==="LK"?_=k*.025:_=k*.05);let $=null;const{data:U}=await v.from("students").select("id").ilike("name",`%${s.value.studentName}%`).limit(1);U&&U.length>0&&($=U[0].id);const{error:O}=await v.from("payments").insert({student_id:$,amount:k,payment_date:new Date().toISOString(),payment_month:s.value.month,status:s.value.status,platform_fee:_});if(O)throw O;p.notify({type:"positive",message:`Payment recorded. (Fee: ${_})`}),E()}catch(n){console.error(n),p.notify({type:"negative",message:"Failed to save payment: "+n.message})}},w=u("February"),I=u("All Classes"),W=[{name:"student",label:"Student Name",field:"student",align:"left"},{name:"grade",label:"Grade",field:"grade",align:"left"},{name:"phone",label:"Parent Contact",field:"phone",align:"left"},{name:"amount",label:"Due Amount",field:"amount",align:"right",format:n=>i.format(Number(n.replace(",","")))},{name:"actions",label:"Actions",field:"actions",align:"right"}],B=u([{id:101,student:"Shehan Perera",grade:"Grade 10",phone:"0771122334",amount:"2,500"},{id:102,student:"Kavindi Silva",grade:"Grade 11",phone:"0714455667",amount:"3,000"},{id:103,student:"Ruwan Dissnayake",grade:"Grade 10",phone:"0708899001",amount:"2,500"}]),X=n=>{p.notify({type:"info",icon:"sms",message:`SMS reminder sent to ${n.student}'s parent.`})},Y=n=>{s.value={studentName:n.student,amount:n.amount.replace(",",""),status:"Paid",month:w.value},y.value=!0},D=u(!1),d=u({}),Z=[{name:"date",label:"Date",field:"date",align:"left"},{name:"category",label:"Category",field:"category",align:"left"},{name:"description",label:"Description",field:"description",align:"left"},{name:"amount",label:"Amount",field:"amount",align:"right",format:n=>i.format(n)}],N=u([{id:1,date:"2026-02-05",category:"Rent",description:"Monthly Hall Rent",amount:5e4},{id:2,date:"2026-02-08",category:"Electricity",description:"Jan Bill",amount:12500}]),G=j(()=>N.value.reduce((n,t)=>n+Number(t.amount),0)),x=j(()=>Qe-G.value),ee=()=>{d.value={date:new Date().toISOString().split("T")[0]},D.value=!0},te=()=>{N.value.unshift({id:Date.now(),date:d.value.date||new Date().toISOString().split("T")[0],category:d.value.category,description:d.value.description,amount:Number(d.value.amount)}),p.notify({type:"positive",message:"Expense saved"})};return(n,t)=>(ne(),se(ie,{class:"q-pa-lg"},{default:l(()=>[t[19]||(t[19]=o("div",{class:"row items-center justify-between q-mb-lg"},[o("div",null,[o("h1",{class:"text-h5 text-weight-bold q-my-none"},"Financial Management"),o("p",{class:"text-grey-5 q-mt-xs q-mb-none"}," Manage tuition fees, track dues, and record expenses. ")])],-1)),e(r,{class:"no-shadow border-gray q-mb-lg"},{default:l(()=>[e(ae,{modelValue:b.value,"onUpdate:modelValue":t[0]||(t[0]=a=>b.value=a),dense:"",class:"text-grey","active-color":"primary","indicator-color":"primary",align:"left","narrow-indicator":""},{default:l(()=>[e(T,{name:"payments",label:"Student Payments",icon:"payments"}),e(T,{name:"due",label:"Due Payments",icon:"pending_actions"}),e(T,{name:"expenses",label:"Institute Expenses",icon:"account_balance_wallet"})]),_:1},8,["modelValue"])]),_:1}),e(le,{modelValue:b.value,"onUpdate:modelValue":t[3]||(t[3]=a=>b.value=a),animated:"",class:"bg-transparent"},{default:l(()=>[e(F,{name:"payments",class:"q-pa-none"},{default:l(()=>[o("div",ge,[e(m,{unelevated:"",icon:"add",color:"primary",label:"New Payment","no-caps":"",onClick:K})]),o("div",fe,[o("div",ve,[e(r,{class:"no-shadow border-gray q-pa-md bg-green-1"},{default:l(()=>[t[13]||(t[13]=o("div",{class:"text-caption text-green-9 text-uppercase text-weight-bold"}," Total Revenue (This Month) ",-1)),o("div",be,c(g(i).format(125e3)),1)]),_:1})]),o("div",ye,[e(r,{class:"no-shadow border-gray q-pa-md bg-orange-1"},{default:l(()=>[t[14]||(t[14]=o("div",{class:"text-caption text-orange-9 text-uppercase text-weight-bold"}," Total Pending ",-1)),o("div",we,c(g(i).format(45e3)),1)]),_:1})])]),e(r,{class:"no-shadow border-gray"},{default:l(()=>[e(R,{rows:A.value,columns:J,"row-key":"id",flat:"",pagination:{rowsPerPage:10}},{"body-cell-student":l(a=>[e(S,{props:a,class:"text-weight-bold"},{default:l(()=>[V(c(a.row.student),1)]),_:2},1032,["props"])]),"body-cell-status":l(a=>[e(S,{props:a},{default:l(()=>[e(re,{color:a.row.status==="Paid"?"green":"orange",label:a.row.status,class:"q-px-sm"},null,8,["color","label"])]),_:2},1032,["props"])]),_:1},8,["rows"])]),_:1})]),_:1}),e(F,{name:"due",class:"q-pa-none"},{default:l(()=>[o("div",xe,[o("div",he,[e(C,{outlined:"",modelValue:w.value,"onUpdate:modelValue":t[1]||(t[1]=a=>w.value=a),options:["January","February","March"],label:"Month",dense:"","bg-color":"white"},null,8,["modelValue"])]),o("div",_e,[e(C,{outlined:"",modelValue:I.value,"onUpdate:modelValue":t[2]||(t[2]=a=>I.value=a),options:["All Classes","Grade 10 - Maths","Grade 11 - Science"],label:"Class",dense:"","bg-color":"white"},null,8,["modelValue"])])]),e(r,{class:"no-shadow border-gray"},{default:l(()=>[e(ue,{rounded:"",class:"bg-red-1 text-red-9 q-mb-none"},{avatar:l(()=>[e(de,{name:"warning",color:"red"})]),default:l(()=>[t[15]||(t[15]=V(" Found ",-1)),o("strong",null,c(B.value.length)+" students",1),V(" with outstanding payments for "+c(w.value)+". ",1)]),_:1}),e(R,{rows:B.value,columns:W,"row-key":"id",flat:""},{"body-cell-actions":l(a=>[e(S,{props:a,align:"right"},{default:l(()=>[e(m,{size:"sm",color:"primary",icon:"sms",label:"Send Reminder",class:"q-mr-sm",onClick:h=>X(a.row)},null,8,["onClick"]),e(m,{size:"sm",outline:"",color:"green",icon:"payments",label:"Pay Now",onClick:h=>Y(a.row)},null,8,["onClick"])]),_:2},1032,["props"])]),_:1},8,["rows"])]),_:1})]),_:1}),e(F,{name:"expenses",class:"q-pa-none"},{default:l(()=>[o("div",Ve,[e(m,{unelevated:"",color:"deep-orange",icon:"add",label:"Add Expense","no-caps":"",onClick:ee})]),o("div",qe,[o("div",Pe,[e(r,{class:"no-shadow border-gray q-pa-md bg-red-1"},{default:l(()=>[t[16]||(t[16]=o("div",{class:"text-caption text-red-9 text-uppercase text-weight-bold"}," Total Expenses ",-1)),o("div",Se,c(g(i).format(G.value)),1)]),_:1})]),o("div",Ce,[e(r,{class:M(["no-shadow border-gray q-pa-md",x.value>=0?"bg-blue-1":"bg-orange-1"])},{default:l(()=>[o("div",{class:M(["text-caption text-uppercase text-weight-bold",x.value>=0?"text-blue-9":"text-orange-9"])}," Net Profit ",2),o("div",{class:M(["text-h4 text-weight-bold q-mt-xs",x.value>=0?"text-blue-9":"text-orange-9"])},c(g(i).format(x.value)),3)]),_:1},8,["class"])])]),e(r,{class:"no-shadow border-gray"},{default:l(()=>[e(R,{rows:N.value,columns:Z,"row-key":"id",flat:""},{"body-cell-amount":l(a=>[e(S,{props:a,class:"text-right text-weight-bold"},{default:l(()=>[V(c(a.row.amount.toLocaleString()),1)]),_:2},1032,["props"])]),_:1},8,["rows"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(z,{modelValue:y.value,"onUpdate:modelValue":t[8]||(t[8]=a=>y.value=a)},{default:l(()=>[e(r,{style:{"min-width":"400px"}},{default:l(()=>[e(q,null,{default:l(()=>[...t[17]||(t[17]=[o("div",{class:"text-h6"},"Record New Payment",-1)])]),_:1}),e(q,{class:"q-pt-none q-gutter-y-md"},{default:l(()=>[e(f,{outlined:"",modelValue:s.value.studentName,"onUpdate:modelValue":t[4]||(t[4]=a=>s.value.studentName=a),label:"Student Name",dense:""},null,8,["modelValue"]),e(C,{outlined:"",modelValue:s.value.month,"onUpdate:modelValue":t[5]||(t[5]=a=>s.value.month=a),options:["January","February","March"],label:"Month",dense:""},null,8,["modelValue"]),e(f,{outlined:"",modelValue:s.value.amount,"onUpdate:modelValue":t[6]||(t[6]=a=>s.value.amount=a),label:"Amount ("+g(i).currency+")",type:"number",dense:""},null,8,["modelValue","label"]),e(C,{outlined:"",modelValue:s.value.status,"onUpdate:modelValue":t[7]||(t[7]=a=>s.value.status=a),options:["Paid","Pending"],label:"Status",dense:""},null,8,["modelValue"])]),_:1}),e(L,{align:"right"},{default:l(()=>[P(e(m,{flat:"",label:"Cancel",color:"grey-7"},null,512),[[Q]]),P(e(m,{unelevated:"",label:"Save",color:"primary",onClick:H},null,512),[[Q]])]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(z,{modelValue:D.value,"onUpdate:modelValue":t[12]||(t[12]=a=>D.value=a)},{default:l(()=>[e(r,{style:{"min-width":"400px"}},{default:l(()=>[e(q,null,{default:l(()=>[...t[18]||(t[18]=[o("div",{class:"text-h6"},"Record Expense",-1)])]),_:1}),e(q,{class:"q-pt-none q-gutter-y-md"},{default:l(()=>[e(f,{outlined:"",modelValue:d.value.category,"onUpdate:modelValue":t[9]||(t[9]=a=>d.value.category=a),label:"Category",dense:""},null,8,["modelValue"]),e(f,{outlined:"",modelValue:d.value.description,"onUpdate:modelValue":t[10]||(t[10]=a=>d.value.description=a),label:"Description",dense:""},null,8,["modelValue"]),e(f,{outlined:"",modelValue:d.value.amount,"onUpdate:modelValue":t[11]||(t[11]=a=>d.value.amount=a),label:"Amount ("+g(i).currency+")",type:"number",dense:""},null,8,["modelValue","label"])]),_:1}),e(L,{align:"right"},{default:l(()=>[P(e(m,{flat:"",label:"Cancel",color:"grey-7"},null,512),[[Q]]),P(e(m,{unelevated:"",label:"Save",color:"deep-orange",onClick:te},null,512),[[Q]])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1}))}},et=pe(De,[["__scopeId","data-v-58de616d"]]);export{et as default};
