import{H as le,bc as ie,h as re,bd as ne,w as H,aJ as de,o as ce,b as ue,m as r,n as Q,p as a,q as l,f as t,P as R,N as b,y as d,F as J,B as O,D as me,U as V,v as m,z as g,C as M,V as ge,Q as _,t as F,R as pe,S as fe,X as ve,aa as he,r as c,O as u,c as _e}from"./index-BCoBQOFT.js";import{Q as K}from"./QBadge-CD0MS9Rg.js";import{Q as z,a as p}from"./QItem-Wb4A_Ad7.js";import{Q as T}from"./QItemLabel-djxoAbwS.js";import{Q as G}from"./QList-TwHTGU55.js";import{Q as Z}from"./QScrollArea-DpvqNk2s.js";import{Q as xe}from"./QSpace-BMoCBDdG.js";import{Q as ye}from"./QToolbar-D2GMqklU.js";import{Q as X}from"./QTooltip-C3k5xbmb.js";import{Q as be}from"./QChip-B9sWOFsV.js";import{Q as we}from"./QPage-DNQfSVvF.js";import{u as Se}from"./use-quasar-DuPF83ky.js";import{_ as Ce}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./QResizeObserver-CLJoVRmi.js";import"./QScrollObserver-B5hpTMde.js";import"./TouchPan-DDYz_H52.js";import"./touch-BjYP5sR0.js";import"./position-engine-BGz6yeZ8.js";import"./format-CoaQEihs.js";const ke='<circle cx="15" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="60" cy="15" r="9" fill-opacity=".3"><animate attributeName="r" from="9" to="9" begin="0s" dur="0.8s" values="9;15;9" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from=".5" to=".5" begin="0s" dur="0.8s" values=".5;1;.5" calcMode="linear" repeatCount="indefinite"></animate></circle><circle cx="105" cy="15" r="15"><animate attributeName="r" from="15" to="15" begin="0s" dur="0.8s" values="15;9;15" calcMode="linear" repeatCount="indefinite"></animate><animate attributeName="fill-opacity" from="1" to="1" begin="0s" dur="0.8s" values="1;.5;1" calcMode="linear" repeatCount="indefinite"></animate></circle>',D=le({name:"QSpinnerDots",props:ie,setup($){const{cSize:v,classes:x}=ne($);return()=>re("svg",{class:x.value,fill:"currentColor",width:v.value,height:v.value,viewBox:"0 0 120 30",xmlns:"http://www.w3.org/2000/svg",innerHTML:ke})}}),qe={class:"contacts-sidebar bg-dark-card border-glass-right flex column"},Qe={class:"q-pa-lg"},Me={key:0,class:"flex flex-center q-pa-lg"},ze=["src"],Te={class:"text-caption text-grey-6"},Ae={class:"chat-main col flex column bg-slate-50 relative-position"},Ne={key:0,class:"full-height flex column"},Ie=["src"],Le={class:"text-weight-bold"},Ue={class:"text-caption text-emerald"},Ve={key:0,class:"flex flex-center full-height"},De={key:1,class:"column q-gutter-y-md"},$e={class:"text-right text-mini opacity-70 q-mt-xs"},Be={key:0,class:"row justify-start q-mb-md"},Pe={class:"message-bubble received q-pa-sm bg-white text-dark shadow-1"},je={key:0,class:"q-px-lg q-pt-sm"},Ee={class:"ai-suggestion-card bg-purple-1 border-purple-light q-pa-sm rounded-borders-10 flex items-center justify-between"},He={class:"row items-center no-wrap overflow-hidden"},Re={class:"text-caption text-purple-9 text-italic ellipsis"},Je={class:"q-pa-md bg-white border-top-light"},Oe={class:"row q-gutter-x-sm items-center no-wrap"},Fe={key:1,class:"full-height flex flex-center column text-grey-5"},Ke={key:0,class:"info-sidebar bg-white border-light-left gt-md flex column"},Ge={class:"q-pa-lg text-center"},Ze=["src"],Xe={class:"text-h6 text-weight-bold text-dark"},Ye={class:"q-px-sm"},We={__name:"ChatPage",setup($){const v=Se(),x=c(""),f=c(""),i=c(null),A=c(!1),N=c(!1),I=c([]),y=c([]),w=c(!1),S=c(""),L=c(!1),U=c(null);let h=null;const Y=()=>{U.value&&U.value.setScrollPercentage("vertical",1,300)};H(y,()=>{de(Y)},{deep:!0});const W=_e(()=>{if(!x.value)return I.value;const o=x.value.toLowerCase();return I.value.filter(e=>e.name.toLowerCase().includes(o)||e.email&&e.email.toLowerCase().includes(o))}),ee=async()=>{if(!i.value){v.notify({type:"warning",message:"Please select a contact first"});return}const o=["I'm interested in the pricing.","Do you have a support team?","Can we jump on a call?","How does the automation work?"],e=o[Math.floor(Math.random()*o.length)],{error:s}=await u.from("messages").insert({lead_id:i.value.id,content:e,is_from_lead:!0});s?(console.error("Simulation error:",s),v.notify({type:"negative",message:"Simulation failed: "+s.message})):v.notify({type:"info",message:"Simulated message sent!",position:"top"})},B=async(o=!1,e=null)=>{const s="AIzaSyBmazATys8hcIJUgMHpZuSxEUQU038HLFg",n=e||y.value;if(!(!i.value||n.length===0)){w.value=!0;try{const C=n.slice(-3).map(q=>`${q.sent?"Support":"Client"}: ${q.text}`).join(`
`),k=await(await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${s}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`You are an elite business assistant for DigyNex Systems. Based on this chat history, draft a professional, concise, and helpful response to the client. Keep it natural and direct. 

History:
${C}

Draft Response:`}]}]})})).json();if(k.error)throw console.error("Gemini API Error:",k.error),new Error(k.error.message);const j=k.candidates[0].content.parts[0].text.trim();if(o){const{data:q}=await u.auth.getUser(),{error:E}=await u.from("messages").insert({lead_id:i.value.id,sender_id:q.user.id,content:j,is_from_lead:!1});E&&console.error("Auto-reply send error:",E)}else f.value=j}catch(C){console.error("AI Strategy Error:",C),o||v.notify({type:"negative",message:"AI failed to strategize: "+C.message})}w.value=!1}},te=async o=>{const e="AIzaSyBmazATys8hcIJUgMHpZuSxEUQU038HLFg";try{const n=await(await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`Give a very short (max 10 words) fast suggestion to reply to this message: "${o}"`}]}]})})).json();S.value=n.candidates[0].content.parts[0].text.trim()}catch{}},se=async()=>{A.value=!0;const{data:o,error:e}=await u.from("leads").select("*").order("name",{ascending:!0});e?console.error("Error fetching contacts:",e):I.value=o.map(s=>({...s,avatar:`https://ui-avatars.com/api/?name=${encodeURIComponent(s.name)}&background=random&color=fff`,lastMsg:"Ongoing orchestration...",time:"Just now",online:Math.random()>.5,unread:!1})),A.value=!1},ae=async o=>{if(!o)return;N.value=!0;const{data:e,error:s}=await u.from("messages").select("*").eq("lead_id",o).order("created_at",{ascending:!0});s?console.error("Error fetching messages:",s):y.value=e.map(n=>({id:n.id,sent:!n.is_from_lead,text:n.content,time:new Date(n.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})),N.value=!1},P=async()=>{if(!f.value.trim()||!i.value)return;const o=f.value;f.value="";const{data:e}=await u.auth.getUser(),s=e.user.id,{error:n}=await u.from("messages").insert({lead_id:i.value.id,sender_id:s,content:o,is_from_lead:!1});n&&(v.notify({type:"negative",message:"Failed to send message"}),f.value=o)},oe=o=>{h&&u.removeChannel(h),console.log("Attaching realtime subscription for lead:",o),h=u.channel(`messages:${o}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`lead_id=eq.${o}`},e=>{console.log("Realtime message received:",e.new);const s={id:e.new.id,sent:!e.new.is_from_lead,text:e.new.content,time:new Date(e.new.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})};y.value.find(n=>String(n.id)===String(s.id))||(y.value.push(s),e.new.is_from_lead&&(te(e.new.content),L.value&&setTimeout(()=>{B(!0)},1500)))}).subscribe(e=>{console.log(`Subscription status for lead ${o}:`,e)})};return H(i,o=>{o?(ae(o.id),oe(o.id)):h&&(u.removeChannel(h),h=null)}),ce(()=>{se()}),ue(()=>{h&&u.removeChannel(h)}),(o,e)=>(r(),Q(we,{class:"chat-page flex flex-stretch no-scroll"},{default:a(()=>[l("div",qe,[l("div",Qe,[e[4]||(e[4]=l("div",{class:"text-h6 text-white text-weight-bold q-mb-md"},"Conversations",-1)),t(R,{modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=s=>x.value=s),placeholder:"Search leads...",dark:"",outlined:"",dense:"",rounded:"",class:"bg-black-opacity"},{prepend:a(()=>[t(b,{name:"search",size:"xs"})]),_:1},8,["modelValue"])]),t(Z,{class:"col"},{default:a(()=>[A.value?(r(),d("div",Me,[t(D,{color:"blue",size:"40px"})])):(r(),Q(G,{key:1,dark:""},{default:a(()=>[(r(!0),d(J,null,O(W.value,s=>me((r(),Q(z,{key:s.id,clickable:"",active:i.value?.id===s.id,"active-class":"active-contact",onClick:n=>i.value=s,class:"q-mx-sm rounded-borders q-mb-xs"},{default:a(()=>[t(p,{avatar:""},{default:a(()=>[t(V,{size:"45px"},{default:a(()=>[l("img",{src:s.avatar},null,8,ze),t(K,{floating:"",rounded:"",color:s.online?"green":"grey",style:{width:"12px",height:"12px"}},null,8,["color"])]),_:2},1024)]),_:2},1024),t(p,null,{default:a(()=>[t(T,{class:"text-weight-bold text-white"},{default:a(()=>[m(g(s.name),1)]),_:2},1024),t(T,{caption:"",lines:"1",class:"text-grey-5"},{default:a(()=>[m(g(s.lastMsg),1)]),_:2},1024)]),_:2},1024),t(p,{side:""},{default:a(()=>[l("div",Te,g(s.time),1),s.unread?(r(),Q(K,{key:0,color:"blue",rounded:"",label:"1",class:"q-mt-xs"})):M("",!0)]),_:2},1024)]),_:2},1032,["active","onClick"])),[[ge]])),128))]),_:1}))]),_:1})]),l("div",Ae,[i.value?(r(),d("div",Ne,[t(ye,{class:"bg-dark-card border-glass-bottom text-white q-py-sm"},{default:a(()=>[t(V,{size:"40px",class:"q-mr-md"},{default:a(()=>[l("img",{src:i.value.avatar},null,8,Ie)]),_:1}),l("div",null,[l("div",Le,g(i.value.name),1),l("div",Ue,g(i.value.online?"Active Now":"Last seen 2h ago"),1)]),t(xe),t(_,{flat:"",round:"",icon:"videocam",color:"grey-5"}),t(_,{flat:"",round:"",icon:"call",color:"grey-5"}),t(_,{flat:"",round:"",icon:"more_vert",color:"grey-5"})]),_:1}),t(Z,{ref_key:"chatScroll",ref:U,class:"col q-pa-md bg-chat-pattern"},{default:a(()=>[N.value?(r(),d("div",Ve,[t(D,{color:"primary",size:"40px"})])):(r(),d("div",De,[(r(!0),d(J,null,O(y.value,s=>(r(),d("div",{key:s.id,class:F(["row",s.sent?"justify-end":"justify-start"])},[l("div",{class:F(["message-bubble q-pa-md shadow-2",s.sent?"sent bg-blue-gradient text-white":"received bg-white text-dark"])},[m(g(s.text)+" ",1),l("div",$e,g(s.time),1)],2)],2))),128)),w.value?(r(),d("div",Be,[l("div",Pe,[t(D,{size:"20px",color:"blue-9"})])])):M("",!0)]))]),_:1},512),S.value&&!f.value?(r(),d("div",je,[l("div",Ee,[l("div",He,[t(b,{name:"auto_awesome",color:"purple-7",size:"18px",class:"q-mr-sm"}),l("div",Re,' AI Suggestion: "'+g(S.value)+'" ',1)]),t(_,{flat:"",dense:"",rounded:"",color:"purple-9",label:"Use This","no-caps":"",size:"sm",onClick:e[1]||(e[1]=s=>f.value=S.value)})])])):M("",!0),l("div",Je,[l("div",Oe,[t(_,{flat:"",round:"",icon:"add_circle_outline",color:"grey-7"}),t(R,{modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=s=>f.value=s),placeholder:"Type your strategic response...",outlined:"",dense:"",rounded:"",class:"col",onKeyup:pe(P,["enter"])},{append:a(()=>[t(_,{flat:"",round:"",dense:"",icon:"auto_awesome",color:w.value?"purple":"grey-5",onClick:B,loading:w.value},{default:a(()=>[t(X,null,{default:a(()=>[...e[5]||(e[5]=[m("Generate Strategic Reply (Gemini AI)",-1)])]),_:1})]),_:1},8,["color","loading"])]),_:1},8,["modelValue"]),t(_,{unelevated:"",round:"",color:"primary",icon:"send",class:"bg-blue-gradient",onClick:P})])])])):(r(),d("div",Fe,[t(b,{name:"forum",size:"100px",class:"opacity-10"}),e[6]||(e[6]=l("div",{class:"text-h6 q-mt-md"},"Select a conversation to begin orchestration",-1))]))]),i.value?(r(),d("div",Ke,[l("div",Ge,[t(V,{size:"120px",class:"q-mb-md shadow-10"},{default:a(()=>[l("img",{src:i.value.avatar},null,8,Ze)]),_:1}),l("div",Xe,g(i.value.name),1),t(be,{color:"blue-1","text-color":"blue-9",class:"q-mt-sm"},{default:a(()=>[...e[7]||(e[7]=[m("Strategic Lead",-1)])]),_:1})]),t(fe,{inset:"",class:"q-my-md"}),t(G,{class:"q-px-md"},{default:a(()=>[t(T,{header:"",class:"text-weight-bold text-uppercase",style:{"font-size":"11px"}},{default:a(()=>[...e[8]||(e[8]=[m("Contact Details",-1)])]),_:1}),t(z,null,{default:a(()=>[t(p,{avatar:""},{default:a(()=>[t(b,{name:"email",color:"grey-7"})]),_:1}),t(p,null,{default:a(()=>[m(g(i.value.email||"sarah@starlight.com"),1)]),_:1})]),_:1}),t(z,null,{default:a(()=>[t(p,{avatar:""},{default:a(()=>[t(b,{name:"phone",color:"grey-7"})]),_:1}),t(p,null,{default:a(()=>[...e[9]||(e[9]=[m("+46 70 123 45 67",-1)])]),_:1})]),_:1}),t(T,{header:"",class:"text-weight-bold text-uppercase q-mt-md",style:{"font-size":"11px"}},{default:a(()=>[...e[10]||(e[10]=[m("Nexus Intelligence Control",-1)])]),_:1}),l("div",Ye,[t(ve,{flat:"",class:"bg-blue-gradient text-white rounded-borders shadow-1 q-mb-sm overflow-hidden",style:{border:"1px solid rgba(255, 255, 255, 0.1)"}},{default:a(()=>[t(z,{dense:"",class:"q-py-sm"},{default:a(()=>[t(p,{avatar:"",side:"",class:"q-pr-sm"},{default:a(()=>[t(b,{name:"auto_mode",color:"white",size:"18px"})]),_:1}),t(p,null,{default:a(()=>[...e[11]||(e[11]=[l("div",{class:"text-caption text-weight-bold",style:{"font-size":"11px"}},"Auto-Pilot",-1),l("div",{class:"text-mini text-white opacity-80",style:{"font-size":"9px"}}," Auto-reply enabled ",-1)])]),_:1}),t(p,{side:""},{default:a(()=>[t(he,{modelValue:L.value,"onUpdate:modelValue":e[3]||(e[3]=s=>L.value=s),color:"white",dense:"","keep-color":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),t(_,{outline:"",color:"deep-orange",label:"Simulate Lead Message",class:"full-width q-mt-md",icon:"sensors","no-caps":"",onClick:ee},{default:a(()=>[t(X,null,{default:a(()=>[...e[12]||(e[12]=[m("Simulate a message from this lead for testing",-1)])]),_:1})]),_:1})]),_:1})])):M("",!0)]),_:1}))}},yt=Ce(We,[["__scopeId","data-v-5f35d331"]]);export{yt as default};
